<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- <link rel="stylesheet" type="text/css" class="ui" href="https://semantic-ui.com/dist/semantic.min.css"> -->
  <link rel="stylesheet" type="text/css" class="ui" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.css">

  <link rel="stylesheet" href="estilos.min.css" type="text/css">
  <title>Parking</title>
</head>

<body>

  <header>
    <div class="cajaPrecio">
      <label>Precio por hora:</label><label id="precioPorHora" style="cursor:pointer"></label>
    </div>
    <div class="cajaReloj">
      <label>Hora actual:</label><label id="reloj"></label>
    </div>
  </header>




  <div class="terreno">
    <!-- banquetas -->
    <div class="banquetaSuperior"></div>
    <div class="banquetaIzquierda"></div>
    <div class="banquetaDerecha"></div>
    <div class="banquetaBC"></div>
    <div class="casetaUno"><p>SALIDA</p></div>
    <div class="casetaDos"><p>ENTRADA</p></div>


    <div class="cajonA right">
      <div class="caja" id="A10"><p></p><span>A10</span></div>
      <div class="caja" id="A9"><p></p><span>A9</span></div>
      <div class="caja" id="A8"><p></p><span>A8</span></div>
      <div class="caja" id="A7"><p></p><span>A7</span></div>
      <div class="caja" id="A6"><p></p><span>A6</span></div>
      <div class="caja" id="A5"><p></p><span>A5</span></div>
      <div class="caja" id="A4"><p></p><span>A4</span></div>
      <div class="caja" id="A3"><p></p><span>A3</span></div>
      <div class="caja" id="A2"><p></p><span>A2</span></div>
      <div class="caja discapacidad" id="A1"><p></p><span class="left">A1</span><i class="wheelchair icon"></i></div>
    </div>

    <div class="cajonB1 left">
      <div class="caja" id="B8"><span>B8</span><p></p></div>
      <div class="caja" id="B7"><span>B7</span><p></p></div>
      <div class="caja" id="B6"><span>B6</span><p></p></div>
      <div class="caja" id="B5"><span>B5</span><p></p></div>
    </div>
    <div class="cajonB2 left">
      <div class="caja" id="B4"><span>B4</span><p></p></div>
      <div class="caja" id="B3"><span>B3</span><p></p></div>
      <div class="caja" id="B2"><span>B2</span><p></p></div>
      <div class="caja discapacidad" id="B1"><span>B1</span><p></p><i class="wheelchair icon"></i></div>
    </div>
    <div class="cajonC1 right">
      <div class="caja" id="C8"><p></p><span>C8</span></div>
      <div class="caja" id="C7"><p></p><span>C7</span></div>
      <div class="caja" id="C6"><p></p><span>C6</span></div>
      <div class="caja" id="C5"><p></p><span>C5</span></div>
    </div>
    <div class="cajonC2 right">
      <div class="caja" id="C4"><p></p><span>C4</span></div>
      <div class="caja" id="C3"><p></p><span>C3</span></div>
      <div class="caja" id="C2"><p></p><span>C2</span></div>
      <div class="caja discapacidad" id="C1"><p></p><span>C1</span><i class="wheelchair icon"></i></div>
    </div>

    <div class="cajonD1 left">
      <div class="caja" id="D8"><span>D8</span><p></p></div>
      <div class="caja" id="D7"><span>D7</span><p></p></div>
      <div class="caja" id="D6"><span>D6</span><p></p></div>
      <div class="caja" id="D5"><span>D5</span><p></p></div>
    </div>
    <div class="cajonD2 left">
      <div class="caja" id="D4"><span>D4</span><p></p></div>
      <div class="caja" id="D3"><span>D3</span><p></p></div>
      <div class="caja" id="D2"><span>D2</span><p></p></div>
      <div class="caja discapacidad" id="D1"><span>D1</span><p></p><i class="wheelchair icon"></i></div>
    </div>
    <div class="cajonE1 right">
      <div class="caja" id="E8"><p></p><span>E8</span></div>
      <div class="caja" id="E7"><p></p><span>E7</span></div>
      <div class="caja" id="E6"><p></p><span>E6</span></div>
      <div class="caja" id="E5"><p></p><span>E5</span></div>
    </div>
    <div class="cajonE2 right">
      <div class="caja" id="E4"><p></p><span>E4</span></div>
      <div class="caja" id="E3"><p></p><span>E3</span></div>
      <div class="caja" id="E2"><p></p><span>E2</span></div>
      <div class="caja discapacidad" id="E1"><p></p><span>E1</span><i class="wheelchair icon"></i></div>
    </div>

    <div class="cajonF1 left">
      <div class="caja" id="F8"><span>F8</span><p></p></div>
      <div class="caja" id="F7"><span>F7</span><p></p></div>
      <div class="caja" id="F6"><span>F6</span><p></p></div>
      <div class="caja" id="F5"><span>F5</span><p></p></div>
    </div>
    <div class="cajonF2 left">
      <div class="caja" id="F4"><span>F4</span><p></p></div>
      <div class="caja" id="F3"><span>F3</span><p></p></div>
      <div class="caja" id="F2"><span>F2</span><p></p></div>
      <div class="caja discapacidad" id="F1"><span>F1</span><p></p><i class="wheelchair icon"></i></div>
    </div>
    <div class="cajonG1 right">
      <div class="caja" id="G8"><p></p><span>G8</span></div>
      <div class="caja" id="G7"><p></p><span>G7</span></div>
      <div class="caja" id="G6"><p></p><span>G6</span></div>
      <div class="caja" id="G5"><p></p><span>G5</span></div>
    </div>
    <div class="cajonG2 right">
      <div class="caja" id="G4"><p></p><span>G4</span></div>
      <div class="caja" id="G3"><p></p><span>G3</span></div>
      <div class="caja" id="G2"><p></p><span>G2</span></div>
      <div class="caja discapacidad" id="G1"><p></p><span>G1</span><i class="wheelchair icon"></i></div>
    </div>

    <div class="cajonH left">
      <div class="caja" id="H10"><span>H10</span><p></p></div>
      <div class="caja" id="H9"><span>H9</span><p></p></div>
      <div class="caja" id="H8"><span>H8</span><p></p></div>
      <div class="caja" id="H7"><span>H7</span><p></p></div>
      <div class="caja" id="H6"><span>H6</span><p></p></div>
      <div class="caja" id="H5"><span>H5</span><p></p></div>
      <div class="caja" id="H4"><span>H4</span><p></p></div>
      <div class="caja" id="H3"><span>H3</span><p></p></div>
      <div class="caja" id="H2"><span>H2</span><p></p></div>
      <div class="caja discapacidad" id="H1"><span>H1</span><p></p><i class="wheelchair icon"></i></div>
    </div>
    <div class="entrada"></div>
    <div class="salida"></div>

  </div>
  <p class="mensaje">El sistema no cuenta con versión móvil. </p>



  <div class="carretera">
  </div>


  <div class="ui basic modal"  id="modalAgregar">
    <div class="ui icon header">
      <i style="color:#d9ad00;" class="question icon"></i>
      <p style="text-align:center;color:#d9ad00;">
        ¿Estás totalmente deacuerdo de utilizar el lugar <span id="lugar"></span>?
      </p>
    </div>
    <div class="content">
      <p class="center">Una vez confirmada la acción, se empezará a cobrar la tarifa establecida.</p>
    </div>
    <div class="actions">

      <div class="ui green ok inverted button">
        <i class="checkmark icon"></i>
        Si
      </div>
      <div class="ui red basic cancel inverted button">
        <i class="remove icon"></i>
        No
      </div>
    </div>
  </div>
  <div class="ui small modal" id="modalPagar">
    <div class="header">
      Pagar estacionamiento.
    </div>
    <div class="content">
      <form class="ui form">

        <div class="ui grid">
          <div class="doubling column row">
            <div class="column">

              <div class="ui raised segment" style=" width: 50%; margin: 0 auto;">
                <div class="field inline">
                  <label>Precio por hora:</label> <span id="tarifahora">aqui va alo</span>
                </div>
                <div class="field inline ">
                  <label>Entrada:</label> <span id="entrada">aqui va alo</span>
                </div>
                <div class="field inline ">
                  <label>Salida:</label> <span id="salida">aqui va alo</span>
                </div>
                <div class="field inline ">
                  <label>Tiempo utilizado:</label> <span id="tiempoUtilizada">aqui va alo</span>
                </div>
                <div class="field inline ">
                  <label>Total a pagar:</label> <span id="totalPagar">aqui va alo</span>
                </div>
              </div>

            </div>
          </div>
        </div>


      </form>
    </div>
    <div class="actions">
      <div class="ui positive right labeled icon button">
        Pagar
        <i class="dollar icon"></i>
      </div>
      <div class="ui negative right labled icon button">
        Cancelar
        <i class="remove icon"></i>
      </div>
    </div>
  </div>
  <div class="ui small modal" id="modalTarifa">
    <div class="header">
      Pagar estacionamiento.
    </div>
    <div class="content">
      <form class="ui form">
              <div class="field">
                <label>Precio de la tarifa por hora:</label>
                <input type="number" name="tarifa" id="tarifa" >
              </div>





      </form>
    </div>
    <div class="actions">
      <div class="ui positive right labeled icon button">
        Aceptar
      </div>
      <div class="ui negative right labled icon button">
        Cancelar
      </div>
    </div>
  </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.3.1/semantic.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
    <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCEzU9yQTlQFKxu1eLqJ8O3RsbQ0ZuB4O0",
      authDomain: "parking-4b84c.firebaseapp.com",
      databaseURL: "https://parking-4b84c.firebaseio.com",
      projectId: "parking-4b84c",
      storageBucket: "parking-4b84c.appspot.com",
      messagingSenderId: "605572978415"
    };
    firebase.initializeApp(config);
  </script>


  <script>

  var starCountRef = firebase.database().ref("cajas/");
  var tarifa=0;
  starCountRef.on('value', function(snapshot) {
    $.each(snapshot.val(), function( index, value ) {
      if (value.estado==1) {
        $("#"+value.id).addClass('open');
        var fecha =new Date(value.entrada);

        $("#"+value.id).find("p").html(formatearFecha(fecha));
      }else{
        $("#"+value.id).removeClass('open');
        $("#"+value.id).find("p").html("");
      }
    });
  });

  var starCountRef = firebase.database().ref("config/tarifa");
  starCountRef.on('value', function(snapshot) {
    tarifa=snapshot.val();
   $('#tarifa').val(snapshot.val());
   $('#precioPorHora').html("$"+snapshot.val());
   $('#tarifahora').html("$"+snapshot.val());
  });

  var horaActual;

  $(".caja").click(function() {

    var id= $(this).attr('id');
    $('#lugar').html("'"+id+"'");

    if($(this).hasClass('open')){ //Se ejecuta SE ENCUENTRA OCUPADO
      var salida=new Date().valueOf();
      var starconfig = firebase.database().ref("cajas/"+id+"/");
      starconfig.on('value', function(snapshot) {
        var fechaEntrada = new Date(snapshot.val().entrada);
        fechaSalida =  new Date(salida);
        var tiempoUtilizada= fechaSalida - fechaEntrada;
        tiempoUtilizada= tiempoUtilizada/1000;
        var minutosUtilizados=tiempoUtilizada/60;
        var total=minutosUtilizados/60
        total=total*tarifa;

        $('#entrada').html(formatearFecha(fechaEntrada));
        $('#salida').html(formatearFecha(fechaSalida));
        $('#tiempoUtilizada').html(formatearSegundos(tiempoUtilizada));
        $('#totalPagar').html("$"+parseFloat(total).toFixed(2));
      });


      $('#modalPagar').modal({
        closable  : false,
        onDeny    : function(){
          return true;
        },onApprove : function() {
          firebase.database().ref("cajas/"+id+"/").update({
            salida:salida,
            estado:0
          });
          $("#"+id).removeClass('open');
          $("#"+id).find("p").html("");
        }
      }) .modal('show');



    }else{ // Se ejecuta cuando NO ESTA OCUPADO
      $('#modalAgregar').modal({
        closable  : false,
        onDeny    : function(){
          return true;
        },
        onApprove : function() {
          firebase.database().ref("cajas/"+id+"/").set({
            id: id,
            entrada:new Date().valueOf(),
            salida:0,
            estado:1
          });
        }
      }) .modal('show');
    }

  });


  $("#precioPorHora").click(function() {
    $('#modalTarifa').modal({
      closable  : false,
      onDeny    : function(){
        return true;
      },
      onApprove : function() {
        firebase.database().ref("config/").set({tarifa:parseFloat($('#tarifa').val())});
      }
    }) .modal('show');
  });
  <!--
  /*By George Chiang (WA's JavaScript tutorial)

  Credit must stay intact for use*/
  function formatearFecha(fecha){
    var hours=fecha.getHours();
    var minutes=fecha.getMinutes();
    var seconds=fecha.getSeconds();
    var dn="AM"
    if (hours>12){
      dn="PM";
      hours=hours-12;
    }
    if (hours==0){
      hours=12;
    }
    if (minutes<=9){
      minutes="0"+minutes;
    }
    if (seconds<=9){
      seconds="0"+seconds;
    }
    horaActual=hours+":"+minutes+":"+seconds;
    return horaActual;
  }
  function formatearSegundos(time){
    var hours = Math.floor( time / 3600 );
    var minutes = Math.floor( (time % 3600) / 60 );
    var seconds = time % 60;

    //Anteponiendo un 0 a los minutos si son menos de 10
    minutes = minutes < 10 ? '0' + minutes : minutes;

    //Anteponiendo un 0 a los segundos si son menos de 10
    seconds = seconds < 10 ? '0' + seconds : seconds;

    var result = hours + ":" + minutes + ":" + parseFloat(seconds).toFixed(0);  // 2:41:30
    return result;
  }
  function show(){
    var fecha=new Date()
    var horaActual= formatearFecha(fecha);
    $('#reloj').html(horaActual);
    setTimeout("show()",1000);
  }
  show();
  -->
</script>
</body>

</html>
